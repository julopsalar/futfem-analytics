---
title: "Exploring Statsbomb free data"
author: "Juan LÃ³pez"
date: "2022-12-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This file consists on an exploratory data analysis for free football data provided by Statsbomb.

# Different datasets
There are different types of data available, and these are related

## Competitions
```{r, message=FALSE, warning=FALSE}
library(StatsBombR)
library(dplyr)

# Geeting set of competitions
comps = FreeCompetitions()
dim(comps)
```
In total, this library provides data from 42 different competitions.

```{r}
head(comps)
```
Some attributes are internal to Statsbomb system (ids), but others give us important information

```{r}
comps %>%
  filter(competition_gender == "female") %>%
  select(c(competition_id, competition_name, season_name))
```
There are 6 women's events available, including English Women's Super League, American NWSL and latests World Cup and Eurocup.


## Matches results
It is possible to get matches selecting the competitions from *FreeCompetitions*. Using FA WSL, in season 2020/2021.
```{r, message=FALSE, warning=FALSE}
matches = FreeMatches(Competitions = 
                        comps %>%
                        filter(competition_gender == "female", season_name == "2020/2021"))
head(matches) 
```

After some cleaning...
```{r}
matches$result = if_else(matches$home_score > matches$away_score, 
                                "HOME", 
                                if_else(matches$away_score > matches$home_score, "AWAY", "DRAW"))
head(matches %>%
  select(c(match_id, match_week, match_date, home_team.home_team_name, home_score, away_score,
      away_team.away_team_name, stadium.name, referee.name, result)
  ) %>%
  arrange(match_date) %>%
  rename(
    "home" = "home_team.home_team_name",
    "away" = "away_team.away_team_name",
    "week" = "match_week",
    "date" = "match_date",
    "stadium" = "stadium.name",
    "referee" = "referee.name"
  )
)
```

## Matches events
Also, it is accesible the match eventing generated by Statsbomb.
```{r, warning=FALSE}
some_matches = matches[15,]
events = free_allevents(MatchesDF = some_matches)
#colnames(events)
```



```{r}
unique(events$type.name)

```

# Shoting
```{r}
shots = events %>% filter(type.name == "Shot")
# Drop null columns
not_all_na <- function(x) any(!is.na(x))
shots <- shots %>% select_if(not_all_na)
colnames(shots)
```



# Passing
```{r}
passes = events %>% filter(type.name == "Pass")
# Drop null columns
passes <- passes %>% select_if(not_all_na)
```


# Match Ranking

```{r}

home_rank = matches %>%
  group_by(matches$home_team.home_team_name) %>%
  summarise(MP = n(), W = sum(result == "HOME"), D = sum(result == "DRAW"), L = sum(result == "AWAY"),
            GF = sum(home_score), GA = sum(away_score)) %>%  
  rename("Team" = "matches$home_team.home_team_name")

away_rank = matches %>%
  group_by(matches$away_team.away_team_name) %>%
  summarise(MP = n(), W = sum(result == "AWAY"), D = sum(result == "DRAW"), L = sum(result == "HOME"),
            GF = sum(away_score), GA = sum(home_score)) %>%  
  rename("Team" = "matches$away_team.away_team_name")

rank = rbind(home_rank, away_rank)
rank = aggregate(.~Team, rank, sum)
rank$Points = rank$W * 3 + rank$D
rank$Points_per_match = rank$Points / rank$MP
rank %>%
  arrange(desc(Points_per_match))

```










